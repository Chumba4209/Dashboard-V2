// That confirms whether LVGL 9.x is correctly initialized and communicating with the display

#include <Arduino.h>
#include <TFT_eSPI.h>
#include <lvgl.h>

// Display dimensions
#define SCREEN_WIDTH  320
#define SCREEN_HEIGHT 240

// Draw buffer
static lv_color_t draw_buf[SCREEN_WIDTH * 20];
static lv_display_t *display;

TFT_eSPI tft = TFT_eSPI();

// LVGL flush callback - sends LVGL buffer to TFT
void my_disp_flush(lv_display_t *disp, const lv_area_t *area, uint8_t *px_map) {
    uint32_t w = area->x2 - area->x1 + 1;
    uint32_t h = area->y2 - area->y1 + 1;

    tft.startWrite();
    tft.setAddrWindow(area->x1, area->y1, w, h);
    tft.pushColors((uint16_t *)px_map, w * h, true);
    tft.endWrite();

    lv_display_flush_ready(disp);
}

// LVGL tick - tells LVGL how much time has passed
static uint32_t my_tick(void) {
    return millis();
}

void setup() {
    Serial.begin(115200);

    // Init TFT
    tft.init();
    tft.setRotation(1);
    tft.fillScreen(TFT_BLACK);

    // Init LVGL
    lv_init();
    lv_tick_set_cb(my_tick);

    // Create display driver
    display = lv_display_create(SCREEN_WIDTH, SCREEN_HEIGHT);
    lv_display_set_flush_cb(display, my_disp_flush);
    lv_display_set_buffers(display, draw_buf, NULL,
                           sizeof(draw_buf),
                           LV_DISPLAY_RENDER_MODE_PARTIAL);

    // Simple test - white screen with a label
    lv_obj_set_style_bg_color(lv_screen_active(), lv_color_white(), 0);

    lv_obj_t *label = lv_label_create(lv_screen_active());
    lv_label_set_text(label, "LVGL Working!");
    lv_obj_set_style_text_color(label, lv_color_black(), 0);
    lv_obj_set_style_text_font(label, &lv_font_montserrat_20, 0);
    lv_obj_center(label);
}

void loop() {
    lv_timer_handler();
    delay(5);
}